# Install settings
role_postgresql::listen_address: '*'

# Global settings
role_postgresql::version: '11'

# Databases
role_postgresql::_db:
  drupaldb:
    user: 'drupal_user'
    password: 'password'

# Roles
role_postgresql::_role:
  drupal:
    user: 'drupal_user'
    password: 'password'
  analytics:
    user: 'analytics'
    password: 'password'
    superuser: true

# Grants
role_postgresql::_database_grant:
  drupal:
    privilege: 'ALL'
    db: 'drupaldb'
    role: 'drupal'
  analytics:
    privilege: 'CONNECT'
    db: 'drupaldb'
    role: 'analytics'

# Remote connections
role_postgresql::_pg_hba_rule:
  all:
    description: 'Allow all'
    type: 'host'
    database: 'all'
    user: 'all'
    address: '0.0.0.0/0'
    auth_method: 'md5'

# Configure options in postgresql.conf
role_postgresql::_config_entry:
  logging_collector:
    value: 'on'
  log_destination:
    value: 'csvlog'
  log_filename:
    value: 'pglog'
  log_file_mode:
    value: '0644'
  log_truncate_on_rotation:
    value: 'on'
  log_rotation_age:
    value: '1d'
  log_rotation_age:
    value: '1d'
  log_rotation_size:
    value: '0'
  log_directory:
    value: '/var/log/postgresql'
  log_min_duration_statement:
    value: '0'
  log_min_messages:
    value: 'INFO'

# Cron jobs for analytics
role_postgresql::cron_job_hash:
  analytics:
    minute: "*/1"
    command: psql -t postgresql://analytics:password@localhost/drupaldb -f /opt/postgresql/analytics.sql | jq -c . >> /var/log/postgresql/analytics.json
  iostat:
    minute: "*/1"
    command: "/bin/bash /opt/postgresql/iostat.sh"
