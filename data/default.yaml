# Install settings
role_postgresql::listen_address: '*'

# Global settings
role_postgresql::version: '11'

# Databases
role_postgresql::db_hash:
  drupaldb:
    user: 'drupal_user'
    password: 'password'

# Roles
role_postgresql::_role:
  drupal:
    user: 'drupal_user'
    password: 'password'
  analytics:
    user: 'analytics'
    password: 'password'
    superuser: true

# Grants
role_postgresql::_grant_hash:
  drupal:
    privilege: 'ALL'
    db: 'drupaldb'
    role: 'drupal'
  analytics:
    privilege: 'CONNECT'
    db: 'drupaldb'
    role: 'analytics'

# Remote connections
role_postgresql::_pg_hba_rule:
  all:
    description: 'Allow all'
    type: 'host'
    database: 'all'
    user: 'all'
    address: '0.0.0.0/0'
    auth_method: 'md5'

# Configure options in postgresql.conf
role_postgresql::_config_values:
#  shared_buffers: '2MB'        # override dynamic setting
#  effective_cache_size: '1GB'  # override dynamic setting
  logging_collector: 'on'
  log_destination: 'csvlog'
  log_filename: 'pglog'
  log_file_mode: '0644'
  log_truncate_on_rotation: 'on'
  log_rotation_age: '1d'
  log_rotation_age: '1d'
  log_rotation_size: '0'
  log_directory: '/var/log/postgresql'
  log_min_duration_statement: '0'
  log_min_messages: 'INFO'

# Cron jobs for analytics
role_postgresql::cron_job_hash:
  analytics:
    minute: "*/1"
    command: psql -t postgresql://analytics:password@localhost/drupaldb -f /opt/postgresql/analytics.sql | jq -c . >> /var/log/postgresql/analytics.json
  iostat:
    minute: "*/1"
    command: "/bin/bash /opt/postgresql/iostat.sh"
